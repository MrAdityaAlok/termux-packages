# Use ghc-pkg compiled for host to recache.

--- ghc/hadrian/bindist/Makefile	2023-10-07 08:28:11.000000000 +0530
+++ ghc.mod/hadrian/bindist/Makefile	2024-01-31 19:28:31.809733994 +0530
@@ -235,7 +235,7 @@
 	@echo "Updating the package DB"
 	$(foreach p, $(PKG_CONFS),\
 		$(call patchpackageconf,$(shell echo $(notdir $p) | sed 's/-[0-9.]*-[0-9a-zA-Z]*\.conf//g'),$(shell echo "$p" | sed 's:\0xxx\0:   :g'),$(docdir),$(shell mk/relpath.sh "$(ActualLibsDir)" "$(docdir)"),$(shell echo $(notdir $p) | sed 's/.conf//g')))
-	'$(DESTDIR)$(ActualBinsDir)/$(CrossCompilePrefix)ghc-pkg' --global-package-db "$(DESTDIR)$(ActualLibsDir)/package.conf.d" recache
+	../../stage0/bin/$(CrossCompilePrefix)ghc-pkg --global-package-db "$(DESTDIR)$(ActualLibsDir)/package.conf.d" recache
 
 install_mingw:
 	@echo "Installing MingGW"

--- ghc/hadrian/src/Rules/BinaryDist.hs	2023-10-07 08:28:11.000000000 +0530
+++ ghc.mod/hadrian/src/Rules/BinaryDist.hs	2024-01-31 19:46:40.433110763 +0530
@@ -201,8 +201,8 @@
         --
         -- N.B. the ghc-pkg executable may be prefixed with a target triple
         -- (c.f. #20267).
-        ghcPkgName <- programName (vanillaContext Stage1 ghcPkg)
-        cmd_ (bindistFilesDir -/- "bin" -/- ghcPkgName) ["recache"]
+        ghcPkgName <- programName (vanillaContext stage0InTree ghcPkg)
+        cmd_ (bindistFilesDir -/- "../.." -/- "stage0" -/- "bin" -/- ghcPkgName) ["recache"]
 
 
         -- The settings file must be regenerated by the bindist installation
